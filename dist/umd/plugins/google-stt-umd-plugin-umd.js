!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.GoogleSTTPluginSDK=t():e.GoogleSTTPluginSDK=t()}(self,(()=>(()=>{"use strict";var e={d:(t,o)=>{for(var n in o)e.o(o,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:o[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{GoogleSTT:()=>l});var o=function(){function e(){}return e.prototype.appendPickerHTMLtoChatWindowFooter=function(e){var t=this.hostInstance,o=t.chatEle;"v2"==t.config.UI.version&&o.find(".kore-chat-footer .footerContainer").append(e)},e.prototype.installSpeechToTextTemplate=function(){var e=this,t=e.hostInstance.$;"v2"==e.hostInstance.config.UI.version&&(e.pickerHTML=t(e.getSpeechToTextTemplateString()),e.appendPickerHTMLtoChatWindowFooter(e.pickerHTML),e.bindEvents()),"v3"==e.hostInstance.config.UI.version&&e.bindEventsV3()},e.prototype.getSpeechToTextTemplateString=function(){return'<div class="sdkFooterIcon microphoneBtn">         <button class="notRecordingMicrophone" title="Microphone On">             <i class="microphone"></i>         </button>         <button class="recordingMicrophone" title="Microphone Off" >             <i class="microphone"></i>             <span class="recordingGif"></span>         </button>         <div id="textFromServer"></div>     </div>'},e.prototype.bindEvents=function(){var e=this,t=e.hostInstance.$;t(e.pickerHTML).on("click",".notRecordingMicrophone",(function(t){e.onRecordButtonClick&&e.onRecordButtonClick()})),t(e.pickerHTML).on("click",".recordingMicrophone",(function(t){e.stop(),setTimeout((function(){e.setCaretEnd(document.getElementsByClassName("chatInputBox"))}),350)}))},e.prototype.bindEventsV3=function(){var e=this,t=this,o=t.hostInstance.chatEle;o.querySelector(".voice-compose-btn").addEventListener("click",(function(){t.onRecordButtonClick&&t.onRecordButtonClick(),o.querySelector(".compose-voice-text").style.display="none",o.querySelector(".compose-voice-text-recording").style.display="block",o.querySelectorAll(".action-btn")[0].style.display="none",e.hostInstance.config.branding.footer.buttons.attachment.show&&(o.querySelectorAll(".action-btn")[1].style.display="none"),o.querySelector(".key-board").style.display="none"})),o.querySelector(".voice-compose-btn-recording").addEventListener("click",(function(){""!==o.querySelector(".voice-msg-bubble").textContent.trim()&&(t.stop(),setTimeout((function(){t.setCaretEnd(o.getElementsByClassName("voice-msg-bubble"))}),350),o.querySelector(".compose-voice-text-recording").style.display="none",o.querySelector(".compose-voice-text-end").style.display="block",o.querySelector(".voice-msg-bubble").classList.add("speak-done-bg"))})),o.querySelector(".voice-compose-btn-end").addEventListener("click",(function(){""!==o.querySelector(".voice-msg-bubble").textContent.trim()&&(o.querySelector(".voice-msg-bubble").classList.remove("speak-done-bg"),t.hostInstance.sendMessageToBot(o.querySelector(".voice-msg-bubble").textContent),o.querySelector(".voice-msg-bubble").textContent="",o.querySelector(".voice-speak-msg-info").style.display="none",o.querySelector(".compose-voice-text-end").style.display="none",o.querySelector(".compose-voice-text").style.display="block",o.querySelectorAll(".action-btn")[0].style.display="block",e.hostInstance.config.branding.footer.buttons.attachment.show&&(o.querySelectorAll(".action-btn")[1].style.display="flex"),o.querySelector(".key-board").style.display="block")})),o.querySelector(".cancel-sepak").addEventListener("click",(function(){t.stop(),o.querySelector(".voice-msg-bubble").textContent="",o.querySelector(".voice-speak-msg-info").style.display="none",o.querySelector(".compose-voice-text-recording").style.display="none",o.querySelector(".compose-voice-text").style.display="block",o.querySelectorAll(".action-btn")[0].style.display="block",e.hostInstance.config.branding.footer.buttons.attachment.show&&(o.querySelectorAll(".action-btn")[1].style.display="flex"),o.querySelector(".key-board").style.display="block"})),o.querySelector(".remove-voice-text").addEventListener("click",(function(){o.querySelector(".voice-msg-bubble").textContent="",o.querySelector(".voice-speak-msg-info").style.display="none",t.recognizing?(t.stop(),o.querySelector(".compose-voice-text-recording").style.display="none",o.querySelector(".compose-voice-text").style.display="block",o.querySelectorAll(".action-btn")[0].style.display="block",e.hostInstance.config.branding.footer.buttons.attachment.show&&(o.querySelectorAll(".action-btn")[1].style.display="flex"),o.querySelector(".key-board").style.display="block"):(o.querySelector(".voice-msg-bubble").classList.remove("speak-done-bg"),o.querySelector(".compose-voice-text-end").style.display="none",o.querySelector(".compose-voice-text-recording").style.display="block",t.onRecordButtonClick())}))},e}();const n=o;function i(){var e=function(){function e(e,t,o,n,i,r){this.recLength=0,this.recBuffers=[],this.ratioWeight=0,this.tailExists=!1,this.lastWeight=0,this.fromSampleRate=e,this.toSampleRate=t,this.channels=0|o,this.outputBufferSize=n,this.noReturn=!!i,this.initialize()}return e.prototype.initialize=function(){if(!(this.fromSampleRate>0&&this.toSampleRate>0&&this.channels>0))throw new Error("Invalid settings specified for the resampler.");this.fromSampleRate==this.toSampleRate?(this.resampler=this.bypassResampler,this.ratioWeight=1):(this.compileInterpolationFunction(),this.resampler=this.interpolate,this.ratioWeight=this.fromSampleRate/this.toSampleRate,this.tailExists=!1,this.lastWeight=0,this.initializeBuffers())},e.prototype.compileInterpolationFunction=function(){for(var e="var bufferLength = Math.min(buffer.length, this.outputBufferSize);if ((bufferLength % "+this.channels+") == 0) {if (bufferLength > 0) {var ratioWeight = this.ratioWeight;var weight = 0;",t=0;t<this.channels;++t)e+="var output"+t+" = 0;";for(e+="var actualPosition = 0;var amountToNext = 0;var alreadyProcessedTail = !this.tailExists;this.tailExists = false;var outputBuffer = this.outputBuffer;var outputOffset = 0;var currentPosition = 0;do {  if (alreadyProcessedTail) {    weight = ratioWeight;",t=0;t<this.channels;++t)e+="output"+t+" = 0;";for(e+="}  else {    weight = this.lastWeight;",t=0;t<this.channels;++t)e+="output"+t+" = this.lastOutput["+t+"];";for(e+="alreadyProcessedTail = true;  }  while (weight > 0 && actualPosition < bufferLength) {    amountToNext = 1 + actualPosition - currentPosition;    if (weight >= amountToNext) {",t=0;t<this.channels;++t)e+="output"+t+" += buffer[actualPosition++] * amountToNext;";for(e+="currentPosition = actualPosition;      weight -= amountToNext;    }    else {",t=0;t<this.channels;++t)e+="output"+t+" += buffer[actualPosition"+(t>0?" + "+t:"")+"] * weight;";for(e+="currentPosition += weight;      weight = 0;      break;    }  }  if (weight == 0) {",t=0;t<this.channels;++t)e+="outputBuffer[outputOffset++] = output"+t+" / ratioWeight;";for(e+="}  else {    this.lastWeight = weight;",t=0;t<this.channels;++t)e+="this.lastOutput["+t+"] = output"+t+";";e+='this.tailExists = true;    break;  }} while (actualPosition < bufferLength);return this.bufferSlice(outputOffset);}else {return (this.noReturn) ? 0 : [];}}else {throw(new Error("Buffer was of incorrect sample length."));}',this.interpolate=Function("buffer",e)},e.prototype.bypassResampler=function(e){return this.noReturn?(this.outputBuffer=e,e.length):e},e.prototype.bufferSlice=function(e){if(this.noReturn)return e;try{return this.outputBuffer.subarray(0,e)}catch(t){try{return this.outputBuffer.length=e,this.outputBuffer}catch(t){return this.outputBuffer.slice(0,e)}}},e.prototype.initializeBuffers=function(){try{this.outputBuffer=new Float32Array(this.outputBufferSize),this.lastOutput=new Float32Array(this.channels)}catch(e){this.outputBuffer=[],this.lastOutput=[]}},e.prototype.init=function(e,t){this.sampleRate=e.sampleRate,this.resampler=t},e.prototype.record=function(e){this.recBuffers.push(e[0]),this.recLength+=e[0].length},e.prototype.exportWAV=function(e){var t=this.mergeBuffers(this.recBuffers,this.recLength),o=this.encodeWAV(t),n=new Blob([o],{type:e});postMessage(n)},e.prototype.exportRAW=function(e){var t=this.mergeBuffers(this.recBuffers,this.recLength),o=this.encodeRAW(t),n=new Blob([o],{type:e});postMessage(n)},e.prototype.export16kMono=function(e){var t=this.mergeBuffers(this.recBuffers,this.recLength),o=this.interpolate(t),n=this.encodeRAW(o),i=new Blob([n],{type:e});postMessage(i)},e.prototype.exportSpeex=function(e){},e.prototype.getBuffer=function(){var e=[];e.push(this.mergeBuffers(this.recBuffers,this.recLength)),postMessage(e)},e.prototype.clear=function(){this.recLength=0,this.recBuffers=[]},e.prototype.mergeBuffers=function(e,t){for(var o=new Float32Array(t),n=0,i=0;i<e.length;i++)o.set(e[i],n),n+=e[i].length;return o},e.prototype.interleave=function(e,t){for(var o=e.length+t.length,n=new Float32Array(o),i=0,r=0;i<o;)n[i++]=e[r],n[i++]=t[r],r++;return n},e.prototype.mix=function(e,t){for(var o=e.length,n=new Float32Array(o),i=0,r=0;i<o;)n[i++]=e[r]+t[r],r++;return n},e.prototype.floatTo16BitPCM=function(e,t,o){for(var n=0;n<o.length;n++,t+=2){var i=Math.max(-1,Math.min(1,o[n]));e.setInt16(t,i<0?32768*i:32767*i,!0)}},e.prototype.writeString=function(e,t,o){for(var n=0;n<o.length;n++)e.setUint8(t+n,o.charCodeAt(n))},e.prototype.encodeWAV=function(e){var t=new ArrayBuffer(44+2*e.length),o=new DataView(t);return this.writeString(o,0,"RIFF"),o.setUint32(4,32+2*e.length,!0),this.writeString(o,8,"WAVE"),this.writeString(o,12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,2,!0),o.setUint32(24,this.sampleRate,!0),o.setUint32(28,4*this.sampleRate,!0),o.setUint16(32,4,!0),o.setUint16(34,16,!0),this.writeString(o,36,"data"),o.setUint32(40,2*e.length,!0),this.floatTo16BitPCM(o,44,e),o},e.prototype.encodeRAW=function(e){var t=new ArrayBuffer(2*e.length),o=new DataView(t);return this.floatTo16BitPCM(o,0,e),o},e}(),t=null;addEventListener("message",(function(o){switch(o.data.command){case"init":(t=new e(o.data.config.sampleRate,16e3,1,51200,null,postMessage)).init(o.data.config,t);break;case"record":t.record(o.data.buffer);break;case"exportWAV":t.exportWAV(o.data.type);break;case"exportRAW":t.exportRAW(o.data.type);break;case"export16kMono":t.export16kMono(o.data.type);break;case"getBuffer":t.getBuffer();break;case"clear":t.clear()}}))}const r=function(){function e(e,t){this.recording=!1,this.config=t||{},this.config.bufferLen=this.config.bufferLen||4096,this.context=e.context,this.node=this.context.createScriptProcessor(this.config.bufferLen,1,1),this.worker=new Worker(URL.createObjectURL(new Blob(["(",i.toString(),")()"],{type:"application/javascript"}))),this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate}}),this.recording=!1,this.init(e)}return e.prototype.init=function(e){var t=this;this.node.onaudioprocess=function(e){t.recording&&t.worker.postMessage({command:"record",buffer:[e.inputBuffer.getChannelData(0)]})},this.configure=function(e){for(var o in e)e.hasOwnProperty(o)&&(t.config[o]=e[o])},this.worker.onmessage=function(e){var o=e.data;t.currCallback(o)},e.connect(this.node),this.node.connect(this.context.destination)},e.prototype.record=function(){this.recording=!0},e.prototype.stop=function(){this.recording=!1},e.prototype.clear=function(){this.worker.postMessage({command:"clear"})},e.prototype.getBuffer=function(e){this.currCallback=e||this.config.callback,this.worker.postMessage({command:"getBuffer"})},e.prototype.exportWAV=function(e,t){if(this.currCallback=e||this.config.callback,t=t||this.config.type||"audio/wav",!this.currCallback)throw new Error("Callback not set");this.worker.postMessage({command:"exportWAV",type:t})},e.prototype.exportRAW=function(e,t){if(this.currCallback=e||this.config.callback,t=t||this.config.type||"audio/raw",!this.currCallback)throw new Error("Callback not set");this.worker.postMessage({command:"exportRAW",type:t})},e.prototype.export16kMono=function(e,t){if(this.currCallback=e||this.config.callback,t=t||this.config.type||"audio/raw",!this.currCallback)throw new Error("Callback not set");this.worker.postMessage({command:"export16kMono",type:t})},e.prototype.exportSpeex=function(e,t){if(this.currCallback=e||this.config.callback,t=t||this.config.type||"audio/speex",!this.currCallback)throw new Error("Callback not set");this.worker.postMessage({command:"exportSpeex",type:t})},e.prototype.forceDownload=function(e,t){var o=(window.URL||window.webkitURL).createObjectURL(e),n=window.document.createElement("a");n.href=o,n.download=t||"output.wav";var i=document.createEvent("Event");i.initEvent("click",!0,!0),n.dispatchEvent(i)},e}();var s,c,a=(s=function(e,t){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])},s(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function o(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)});const l=function(e){function t(t){var o=e.call(this)||this;return o.name="GoogleSTT",o.gapiLoaded=!0,o.isRecordingStarted=!1,o.config=t,o.config.key||console.error("Please configure the Google STT API-KEY"),o.config.languageCode||(o.config.languageCode="en"),o}return a(t,e),t.prototype.onHostCreate=function(){var e=this;c=korejquery,this.hostInstance.on("viewInit",(function(t){e.onInit()}))},t.prototype.onInit=function(){this.installSpeechToTextTemplate()},t.prototype.setCaretEnd=function(e){if(e&&e.item(0)&&e.item(0).innerText.length){var t=document.createRange();t.selectNodeContents(e[0]),t.collapse(!1);var o=window.getSelection();o.removeAllRanges(),o.addRange(t),t}else!1,e&&e[0]&&e[0].focus()},t.prototype.uiCallback=function(e){var t=this;e.results&&e.results[0]?(c(".chatInputBox").html(c(".chatInputBox").html()+" "+e.results[0].alternatives[0].transcript),setTimeout((function(){t.setCaretEnd(document.getElementsByClassName("chatInputBox")),document.getElementsByClassName("chatInputBox")[0].scrollTop=document.getElementsByClassName("chatInputBox")[0].scrollHeight}),350)):403===e.code&&(this.gapiLoaded=!1,c(".recordingMicrophone").is(":visible")&&c(".recordingMicrophone").trigger("click"),alert(e.message||"Please provide valid Google speech API key"))},t.prototype.stop=function(){this.isRecordingStarted=!1,clearInterval(this.intervalKey),c(".recordingMicrophone").css("display","none"),c(".notRecordingMicrophone").css("display","block")},t.prototype.sendBlobToSpeech=function(e,t,o){var n=this;if(!this.gapiLoaded)return c(".recordingMicrophone").is(":visible")&&c(".recordingMicrophone").trigger("click"),void alert("Please provide valid Google speech API key");var i=new FileReader;i.addEventListener("loadend",(function(){n.sendBytesToSpeech(btoa(i.result),t,o,n.uiCallback)})),i.readAsBinaryString(e)},t.prototype.sendBytesToSpeech=function(e,t,o,n){var i={audio:{content:e},config:{encoding:t,languageCode:this.config.languageCode,sampleRateHertz:o}};fetch("https://content-speech.googleapis.com/v1/speech:recognize?alt=json&key="+this.config.key,{method:"POST",headers:{Accept:"*/*","Content-Type":"application/json"},body:JSON.stringify(i)}).then((function(e){return e.json()})).then((function(e){console.log(e),n(e)}))},t.prototype.startGoogleSpeech=function(e){var t=this;e&&(e.record(),c(".recordingMicrophone").css("display","block"),c(".notRecordingMicrophone").css("display","none"),console.log("recording..."),this.intervalKey=setInterval((function(){e.export16kMono((function(o){t.sendBlobToSpeech(o,"LINEAR16",16e3),e.clear()}),"audio/x-raw")}),1e3))},t.prototype.successAudioCallback=function(e){var t=this,o=e,n=new(window.AudioContext||window.webkitAudioContext),i=n.createMediaStreamSource(o);window.userSpeechAnalyser=n.createAnalyser(),i.connect(window.userSpeechAnalyser),console.log("Mediastream created");var s=new r(i,{});console.log("Recorder Initialized"),this.startGoogleSpeech(s),setTimeout((function(){t.setCaretEnd(document.getElementsByClassName("chatInputBox"))}),600)},t.prototype.micEnable=function(){var e=this;this.isRecordingStarted||(navigator.getUserMedia||(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),navigator.getUserMedia?(this.isRecordingStarted=!0,navigator.getUserMedia({audio:!0},this.successAudioCallback.bind(this),(function(t){e.isRecordingStarted=!1,alert("Please enable the microphone permission for this page")}))):(this.isRecordingStarted=!1,alert("getUserMedia is not supported in this browser.")))},t.prototype.initializeSTTSpeechRecognition=function(){this.micEnable()},t.prototype.startSTTRecognization=function(){},t.prototype.onRecordButtonClick=function(){this.initializeSTTSpeechRecognition()},t}(n);return t})()));